# Работа с mariabackup

[Назад к главному README](README.md)

**mariabackup** — это официальный инструмент MariaDB для **физического резервного копирования**. Он позволяет быстро создавать полные и инкрементальные бэкапы без остановки сервера.

---

## Основные особенности
- `Физическое копирование данных` — работает на уровне файлов данных MariaDB (.ibd, .frm, журналы транзакций и т. д.), а не через SQL-запросы, как mariadb-dump.
- `Инкрементальные и дифференциальные бэкапы` — можно сохранять только изменения с последнего бэкапа.
- `Минимальная нагрузка на сервер` — не выполняет дорогостоящие SQL-операции.
- `Поддержка горячего бэкапа` — можно снимать бэкап без остановки сервера.
- `Быстрое восстановление` — не нужно импортировать дамп, достаточно вернуть файлы на место.

## Когда лучше использовать mariabackup
- Очень большие базы данных (десятки/сотни ГБ и более).
- Частые резервные копии (ежедневно или чаще).
- Необходимость минимальной нагрузки на сервер во время бэкапа.
- Требуется быстрое восстановление «как есть» на том же сервере или клон на аналогичном окружении.

---

## Хранение пароля
Для безопасности пароль и логин лучше хранить в конфигурационном файле, например `/etc/my.cnf.d/client.cnf`:

```ini
[client]
user=ЛОГИН
password=ПАРОЛЬ
```

Права на файл:
```bash
chmod 600 /etc/my.cnf.d/client.cnf
```

---

## Полный бэкап

```bash
mariabackup --defaults-file=/etc/my.cnf.d/client.cnf \
    --backup \
    --target-dir=/backups/full_$(date +%F)

tar -cf - /backups/full_$(date +%F) | pigz > /backups/full_$(date +%F).tar.gz
```

- `-defaults-file` — файл с логином и паролем (учётные данные MariaDB).
- `--backup` — режим создания копии.
- `--target-dir` — папка, куда сохранить бэкап.

---

## Инкрементальный бэкап

```bash
mariabackup --defaults-file=/etc/my.cnf.d/client.cnf \
    --backup \
    --target-dir=/backups/inc_$(date +%F) \
    --incremental-basedir=/backups/full_2025-08-09

tar -cf - /backups/inc_$(date +%F) | pigz > /backups/inc_$(date +%F).tar.gz
```

- `--incremental-basedir` — путь к базе, от которой берутся изменения.

---

## Подготовка бэкапа к восстановлению

Распаковываем:

```bash
tar -xf /backups/full_2025-08-09.tar.gz -C /backups/
```

Перед восстановлением нужно «применить» журналы транзакций, чтобы база стала консистентной:

```bash
mariabackup --prepare \
    --target-dir=/backups/full_2025-08-09
```

Если есть инкрементальные копии, их нужно последовательно применить:

```bash
mariabackup --prepare \
    --target-dir=/backups/full_2025-08-09 \
    --incremental-dir=/backups/inc_2025-08-10
```

---

## Восстановление

```bash
systemctl stop mariadb

mariabackup --copy-back \
    --target-dir=/backups/full_2025-08-09

chown -R mysql:mysql /var/lib/mysql

systemctl start mariadb
```

- `--copy-back` — копирует файлы из бэкапа в директорию MariaDB.
- После копирования обязательно выставить правильные права на файлы.

---

## Сравнение `mariadb-dump` и `mariabackup`

| Характеристика            | mariadb-dump                          | mariabackup                   |
|---------------------------|---------------------------------------|-------------------------------|
| Тип бэкапа                | Логический (SQL)                      | Физический (файлы)            |
| Универсальность           | Высокая (разные версии, миграции)     | Низкая (только та же версия)  |
| Скорость                  | Медленнее                             | Быстрее                       |
| Размер                    | Больше (текст)                        | Меньше (файлы)                |
| Инкрементальные бэкапы    | Нет                                   | Да                            |
| Нагрузка на сервер        | Высокая                               | Низкая                        |

---

[Назад к главному README](README.md)
