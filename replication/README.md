# MariaDB Репликация: Скрипты настройки Master и Slave

## Описание

В данном репозитории представлены два bash-скрипта для автоматизации настройки репликации MariaDB:
- **setup_master.sh** — конфигурирует сервер как мастер, создает пользователя для репликации, включает бинарные логи и подготавливает данные для слейва.
- **setup_slave.sh** — конфигурирует сервер как слейв, подключает его к мастеру и запускает процесс репликации.

## Требования

- MariaDB установлен и запущен на обоих серверах (master и slave).
- Доступ root к MariaDB на обоих серверах.
- SSH-доступ между серверами для передачи резервной копии.

## Порядок настройки

### 1. Настройка Master-сервера

1. Отредактируйте переменные в `setup_master.sh` при необходимости (IP-адрес слейва, пароли и имя базы).
2. Запустите скрипт на мастер-сервере:
   ```bash
   sudo ./setup_master.sh
   ```
3. После выполнения скрипта сохраните значения `File` и `Position` из вывода `SHOW MASTER STATUS` — они понадобятся для настройки слейва.
4. Передайте резервную копию базы данных на слейв:
   ```bash
   scp /tmp/master_backup.sql <USER>@<SLAVE_IP>:/tmp/
   ```

### 2. Настройка Slave-сервера

1. Отредактируйте переменные в `setup_slave.sh` (IP мастера, пароли, имя бинарного лога и позицию — используйте значения из мастера).
2. Восстановите резервную копию базы данных:
   ```bash
   mysql -u root -p < /tmp/master_backup.sql
   ```
3. Запустите скрипт на слейв-сервере:
   ```bash
   sudo ./setup_slave.sh
   ```
4. Проверьте статус репликации — скрипт выведет результат команды `SHOW SLAVE STATUS\G`.


## Проверка состояния репликации

```sql
SHOW SLAVE STATUS\G;
```
либо
```sql
SHOW REPLICA STATUS\G;
```

### Параметры репликации MariaDB

| Поле                              | Что значит                                                                 | Что должно быть                            |
|-----------------------------------|------------------------------------------------------------------------------|---------------------------------------------|
| `Slave_IO_Running`                | Поток загрузки бинарных логов с мастера                            	 | `Yes`                                       |
| `Slave_SQL_Running`              | Поток применения событий из лога на слейве                                  | `Yes`                                       |
| `Seconds_Behind_Master`          | Задержка реплики в секундах                                                 | `0` или близко к `0`                        |
| `Last_IO_Error`                  | Последняя ошибка в IO-потоке                                                | Пусто                                       |
| `Last_SQL_Error`                 | Последняя ошибка в SQL-потоке                                               | Пусто                                       |
| `Read_Master_Log_Pos`            | Позиция, до которой IO-поток прочитал бинлоги                               | ≈ `Exec_Master_Log_Pos`                     |
| `Exec_Master_Log_Pos`            | Позиция, до которой SQL-поток применил бинлоги                              | ≈ `Read_Master_Log_Pos`                     |
| `Master_Log_File`                | Имя текущего бинарного лога на мастере                                      | Совпадает с `Relay_Master_Log_File`         |
| `Relay_Master_Log_File`          | Лог-файл, который сейчас исполняется                                        | Совпадает с `Master_Log_File`               |
| `Relay_Log_Space`                | Размер relay-логов на диске                                                 | Не растёт бесконтрольно                     |
| `Slave_IO_State`                 | Что делает IO-поток сейчас                                                  | `Waiting for master to send event`          |
| `Slave_SQL_Running_State`        | Что делает SQL-поток сейчас                                                 | `Slave has read all relay log` или idle     |
| `Last_IO_Errno`, `Last_IO_Error` | Код и текст последней IO-ошибки                                            | `0`, пусто                                   |
| `Last_SQL_Errno`, `Last_SQL_Error` | Код и текст последней SQL-ошибки                                          | `0`, пусто                                   |
| `Master_Host`                    | IP или имя мастера                                                          | Соответствует конфигурации                  |
| `Master_User`                    | Пользователь для подключения к мастеру                                      | Репликационный пользователь (`REPLICATION SLAVE`) |
| `Master_Port`                    | Порт подключения к мастеру                                                  | `3306` (или ваш кастомный)                  |
| `Connect_Retry`                  | Интервал повторного подключения (секунды)                                   | Обычно `60`                                 |
| `Using_Gtid`                     | Используется ли GTID                                                        | `Yes` (если настроено)                      |
| `Gtid_IO_Pos`                    | Текущая позиция GTID                                                        | Заполнено, если `Using_Gtid = Yes`          |
| `Auto_Position`                  | Используется ли авто-позиция (GTID)                                         | `1` (если включён GTID)                     |
| `SQL_Delay`                      | Задержка применения SQL событий                                             | `0` (если не используете отложенную реплику)|
| `SQL_Remaining_Delay`            | Сколько ещё ждать до применения событий                                     | `NULL` или `0`                              |
| `Parallel_Mode`                  | Режим параллельного исполнения SQL-потока                                   | `optimistic`, `strict`, или `conservative`  |
| `Master_Server_Id`              | `server_id` мастера                                                        | Совпадает с ID мастера                      |
| `Relay_Log_File`    | Имя текущего relay-лога, из которого SQL-поток применяет события            | Обновляется синхронно с `Relay_Master_Log_File`  |
| `Relay_Log_Pos`     | Текущая позиция чтения внутри `Relay_Log_File`                              | Продвигается вперёд, обычно ≈ `Exec_Master_Log_Pos` |


### Быстрый шаблон оценки:
Если:
- `Slave_IO_Running: Yes`
- `Slave_SQL_Running: Yes`
- `Seconds_Behind_Master: 0`
- `Last_IO_Error: [пусто]`
- `Last_SQL_Error: [пусто]`

Всё работает нормально.
